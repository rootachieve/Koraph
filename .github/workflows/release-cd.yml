name: Release Please + CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: release-please-main
  cancel-in-progress: false

jobs:
  # release-please -> main push 시 변경분을 반영해 release PR을 생성/업데이트하고, 릴리즈 커밋이면 태그/릴리즈를 생성
  release-please:
    name: release-please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}

    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: simple
          target-branch: main
          include-v-in-tag: true
          token: ${{ github.token }}

  release-cd:
    name: release-cd
    runs-on: macos-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}

    steps:
      # 이번 릴리즈 태그 기준으로 코드를 checkout해서 정확히 아티팩트 생성
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}

      # JDK 버전 고정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # JS/Wasm를 위한 Node 런타임 준비
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Android SDK 설치
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # Gradle 캐시
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      # 테스트 및 컴파일 검증
      - name: Verify release build
        run: |
          ./gradlew --no-daemon --stacktrace \
            :graph-visualizer:testDebugUnitTest \
            :graph-visualizer:compileKotlinMetadata \
            :graph-visualizer:compileKotlinJs \
            :graph-visualizer:compileKotlinWasmJs

      # Maven Central(Sonatype)로 publish
      - name: Publish and release to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
          VERSION: ${{ needs.release-please.outputs.version }}
        run: |
          ./gradlew --no-daemon --stacktrace --no-configuration-cache \
            -Pversion="${VERSION}" \
            :graph-visualizer:publishAndReleaseToMavenCentral
